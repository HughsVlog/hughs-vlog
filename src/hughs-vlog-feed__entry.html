<html>
  <template id="hughs-vlog-feed__entry">
    <style>
      :host {
        display: inline-block;
        /*display: inline-flex;*/
        /*width: 360px;*/
        width: 50%;
        position: relative;
      }

      :host([large]) {
        display: block;
        /*display: flex;*/
        /*width: 853px;*/
        width: 100%;
      }

      .hughs-vlog-feed-entry__player {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        max-width: 100%;
      }

      .hughs-vlog-feed-entry__player > iframe,
      .hughs-vlog-feed-entry__player > object,
      .hughs-vlog-feed-entry__player > embed,
      .hughs-vlog-feed-entry__player > img,
      .hughs-vlog-feed-entry__player > svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .flex-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
    
    <a class="flex-container" href="javascript:void(0);">
      <span id="title" class="flex-item"></span>
    </a>
    <div id="player" class="hughs-vlog-feed-entry__player">
      <img src="http://via.placeholder.com/640x360" />
    </div>
  </template>

  <script>//<![CDATA[
  (function () {
    "use strict";

    // http://stackoverflow.com/q/41408477/214325
    var ownerDocument = document.currentScript.ownerDocument;

    class HughsVlogFeedEntry extends HTMLElement {
      
      // Remember to call the super method here
      constructor() {
        super();

        var entry = this;

        const $shadowRoot = this.attachShadow({mode: 'open'});
        const $HughsVlogFeedEntry = ownerDocument.querySelector( '#hughs-vlog-feed__entry' );
        const $shadowContent = $HughsVlogFeedEntry.content.cloneNode( true );

        entry.oembed = null;

        // entry.data = document.createDocumentFragment();

        $shadowRoot.appendChild( $shadowContent );
      } // constructor

      connectedCallback() {
        var entry = this;

        entry.setAttribute( 'role', 'article' );
        entry.setAttribute( 'class', 'hughs-vlog-feed-entry' );

        // console.log( 'entry.data', entry.data );

        var playable = ( entry.parentNode.host.getAttribute( 'playable' ) !== null );

        if ( playable ) {
          entry.getYouTubeLink().then(function ( url ) {
            // console.log( 'response', response );
            return entry.getOembed( url );
          })
          .then(function ( oembed ) {

            // console.log( 'oembed.html', oembed.html );

            // console.log( entry.shadowRoot.querySelector('#player') );

            entry.shadowRoot.querySelector( '#player' ).innerHTML = oembed.html;

            // entry.shadowRoot.querySelector( '#player' ).appendChild(
            //   new DOMParser().parseFromString( oembed.html, 'application/xhtml+xml' ).firstChild
            // );
          })
          .catch(function ( event ) {
            console.log( 'event', event );
          });
        } else {
          // console.log( entry.data );
          entry.parentNode.host.select( 'title', entry.data ).then( function ( response ) {
            if ( response.length && response[0] && ( 'textContent' in response[0] ) ) {
              return response[0].textContent;
            } else {
              throw 'No title';
            }
          } )
          .then( function ( title ) {
            // console.log( title );

            entry.shadowRoot.querySelector( '#title' ).textContent = title;
          } );
          // entry.shadowRoot.querySelector( '#title' ).innerHTML = entry.data.title;
        }
      }

      getYouTubeLink() {
        var entry = this;
        var xpath = 'showing[@type="internet"][@admission="public"]//uri[starts-with(normalize-space(.), "https://www.youtube.com")][1]/text()';

        var selected;

        return entry.parentNode.host.select( xpath, entry.data ).then( function ( response ) {
          if ( response.length && response[0] && ( 'textContent' in response[0] ) ) {
            return response[0].textContent;
          } else {
            throw 'No YouTube Link Found';
          }
        } );
      }

      getOembed( url ) {
        var entry = this;
        var endpoint = 'http://localhost:3000/oembed?url=' + encodeURIComponent( url );

        return new Promise(function HughsVlogFeedEntryGetOembedPromise( resolve, reject ) {
          var xhr = new XMLHttpRequest();
          var oembedJSON;

          xhr.open( 'GET', endpoint, true );
          xhr.setRequestHeader( 'Accept', 'application/xml;q=0.8,text/xml;q=0.6,application/json;q=0.4' );
          
          xhr.onload = function xhrOnLoad( event ) {
            switch ( xhr.status ) {
              case 200:
                oembedJSON = JSON.parse( ( xhr.responseXML || xhr.responseText ) );

                oembedJSON.html = oembedJSON.html.replace( 'allowfullscreen', 'allowfullscreen="allowfullscreen"' ).replace( 'iframe', 'iframe xmlns="http://www.w3.org/1999/xhtml"' );

                // oembedJSON.html = oembedJSON.html.replace( /src="[^"]+"/, 'src="blah.html"' );

                entry.oembed = oembedJSON;

                resolve( entry.oembed );
              break;

              default:
                reject( Error( xhr.statusText ) );
            }
          };

          xhr.onerror = function xhrOnError( event ) {
            reject( Error( 'There was a network error.' ) );
          };

          xhr.send( '' );
        });
      }
    }

    window.customElements.define( 'hughs-vlog-feed__entry', HughsVlogFeedEntry );
  })();
  //]]></script>
</html>