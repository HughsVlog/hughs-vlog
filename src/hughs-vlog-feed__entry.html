<html>
  <template id="hughs-vlog-feed__entry"></template>
  <!-- <iframe
  width="853"
  height="480"
  src="https://www.youtube-nocookie.com/embed/aEmmNJHzjTw"
  frameborder="0"
  allowfullscreen="allowfullscreen"></iframe> -->

  <script>//<![CDATA[
  (function () {
    "use strict";

    // http://stackoverflow.com/q/41408477/214325
    var ownerDocument = document.currentScript.ownerDocument;

    class HughsVlogFeedEntry extends HTMLElement {
      
      // Remember to call the super method here
      constructor() {
        super();

        var entry = this;

        const $shadowRoot = this.attachShadow({mode: 'open'});
        const $HughsVlogFeedEntry = ownerDocument.querySelector( '#hughs-vlog-feed__entry' );
        const $shadowContent = $HughsVlogFeedEntry.content.cloneNode( true );

        entry.oembed = null;

        $shadowRoot.appendChild( $shadowContent );
      } // constructor

      connectedCallback() {
        var entry = this;

        entry.setAttribute( 'role', 'article' );

        entry.getYouTubeLink().then(function ( url ) {
          // console.log( 'response', response );
          return entry.getOembed( url );
        })
        .then(function ( oembed ) {
          console.log( 'oembed', oembed );
        })
      }

      getYouTubeLink() {
        var xpath = '//video/showing[@type="internet"][@admission="public"]/uri[starts-with(normalize-space(.), "https://www.youtube.com")]/text()';

        return this.parentNode.host.select( xpath ).then(function ( response ) {
          return response.textContent;
        });
      }

      getOembed( url ) {
        var endpoint = 'http://www.youtube.com/oembed?url=' + encodeURIComponent( url ) + '&format=xml';

        console.log( endpoint == 'http://www.youtube.com/oembed?url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Do5MaYhQZONY&format=xml' );

        return new Promise(function HughsVlogFeedEntryGetOembedPromise( resolve, reject ) {
          var xhr = new XMLHttpRequest();

          xhr.open( 'GET', endpoint, true );
          xhr.setRequestHeader( 'Accept', 'application/xhtml+xml;q=0.8,text/html;q=0.6' );
          
          xhr.onload = function xhrOnLoad( event ) {
            switch ( xhr.status ) {
              case 200:
                oembed = xhr.responseXML || xhr.responseText;

                resolve( oembed );
              break;

              default:
                reject( Error( xhr.statusText ) );
            }
          };

          xhr.onerror = function xhrOnError( event ) {
            reject( Error( 'There was a network error.' ) );
          };

          xhr.send( '' );
        });
      }
    }

    window.customElements.define( 'hughs-vlog-feed__entry', HughsVlogFeedEntry );
  })();
  //]]></script>
</html>